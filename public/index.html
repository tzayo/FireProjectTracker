<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>מערכת מעקב כיבוי אש - קיבוץ גלאון</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji"; }
      header { padding: 12px 16px; background:#b71c1c; color:white; }
      main { display:flex; height: calc(100vh - 56px); }
      #sidebar { width: 360px; max-width: 45vw; border-left: 1px solid #eee; padding: 12px; overflow: auto; }
      #map { flex:1; }
      h1 { font-size: 20px; margin: 0; }
      .tabs { display:flex; gap:8px; margin:8px 0 12px; }
      .tabs button { padding: 6px 10px; border:1px solid #ccc; background:#fafafa; cursor:pointer; border-radius:6px; }
      .tabs button.active { background:#ffeaea; border-color:#b71c1c; color:#b71c1c; }
      .list { display:grid; gap:8px; }
      .item { border:1px solid #eee; border-radius:8px; padding:8px; }
      label { display:block; font-size:12px; color:#666; }
      input, select { width:100%; padding:6px; margin-top:2px; }
    </style>
  </head>
  <body>
    <header>
      <h1>מערכת מעקב כיבוי אש - קיבוץ גלאון</h1>
    </header>
    <main>
      <div id="sidebar">
        <div class="tabs">
          <button id="tab-map" class="active">מפה</button>
          <button id="tab-hydrants">ברזים</button>
          <button id="tab-cabinets">ארונות</button>
          <button id="tab-tasks">משימות</button>
          <button id="tab-teams">צוותים</button>
        </div>
        <div id="panel"></div>
      </div>
      <div id="map"></div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      const api = (path, opts) => fetch(path, opts).then(r => r.json());

      const map = L.map('map').setView([31.606, 34.817], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const markers = L.layerGroup().addTo(map);
      const refreshMap = async () => {
        markers.clearLayers();
        const fc = await api('/api/map/features');
        fc.features.forEach(f => {
          const [lng, lat] = f.geometry.coordinates;
          const color = f.properties.type === 'hydrant' ? 'red' : 'blue';
          const marker = L.circleMarker([lat, lng], { radius: 8, color }).bindPopup(
            `${f.properties.type === 'hydrant' ? 'ברז' : 'ארון'}: ${f.properties.code}`
          );
          markers.addLayer(marker);
        });
      };

      const setPanel = (html) => { document.getElementById('panel').innerHTML = html; };

      document.getElementById('tab-map').onclick = () => { setActive('tab-map'); setPanel('<p>תצוגת המפה. סמנו שכבות והוסיפו נקודות דרך ה-API.</p>'); };
      document.getElementById('tab-hydrants').onclick = async () => {
        setActive('tab-hydrants');
        const items = await api('/api/hydrants');
        setPanel(`<div class="list">${items.map(h => `<div class="item"><div><strong>קוד:</strong> ${h.code}</div><div><strong>סטטוס:</strong> ${h.status}</div></div>`).join('')}</div>`);
      };
      document.getElementById('tab-cabinets').onclick = async () => {
        setActive('tab-cabinets');
        const items = await api('/api/cabinets');
        setPanel(`<div class="list">${items.map(c => `<div class="item"><div><strong>קוד:</strong> ${c.code}</div><div><strong>סטטוס:</strong> ${c.status}</div></div>`).join('')}</div>`);
      };
      document.getElementById('tab-tasks').onclick = async () => {
        setActive('tab-tasks');
        const items = await api('/api/tasks');
        setPanel(`<div class="list">${items.map(t => `<div class="item"><div><strong>כותרת:</strong> ${t.title}</div><div><strong>סטטוס:</strong> ${t.status}</div></div>`).join('')}</div>`);
      };
      document.getElementById('tab-teams').onclick = async () => {
        setActive('tab-teams');
        const items = await api('/api/teams');
        setPanel(`<div class="list">${items.map(tm => `<div class="item"><div><strong>שם:</strong> ${tm.name}</div><div><strong>פעיל:</strong> ${tm.isActive ? 'כן' : 'לא'}</div></div>`).join('')}</div>`);
      };

      const setActive = (id) => {
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }

      refreshMap();
      setActive('tab-map');
      document.getElementById('tab-map').click();
      setInterval(refreshMap, 10000);
    </script>
  </body>
</html>
